apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      slack_api_url: 'https://hooks.slack.com/services/your-webhook-url'  # Replace in production
      victorops_api_key: 'your-api-key'  # Replace in production
      victorops_api_url: 'https://alert.victorops.com/integrations/generic/20131114/alert'

    templates:
    - '/etc/alertmanager/templates/*.tmpl'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'slack-notifications'
      routes:
      - match:
          severity: critical
        receiver: 'pagerduty-critical'
        continue: true
      - match:
          severity: warning
        receiver: 'slack-notifications'
        continue: true

    receivers:
    - name: 'slack-notifications'
      slack_configs:
      - channel: '#medai-flow-alerts'
        send_resolved: true
        icon_url: https://avatars3.githubusercontent.com/u/3380462
        title: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
        text: >-
          {{ range .Alerts -}}
          *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
          *Description:* {{ .Annotations.description }}
          *Details:*
            {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
            {{ end }}
          {{ end }}

    - name: 'pagerduty-critical'
      pagerduty_configs:
      - routing_key: 'your-pagerduty-key'  # Replace in production
        description: |-
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
        client: 'MedAI Flow'
        client_url: '{{ template "pagerduty.default.client_url" . }}'
        severity: critical

    - name: 'email-notifications'
      email_configs:
      - to: 'oncall@your-domain.com'  # Replace in production
        from: 'alertmanager@your-domain.com'
        smarthost: 'smtp.your-domain.com:587'
        auth_username: 'alerts@your-domain.com'
        auth_password: 'your-smtp-password'  # Replace in production
        require_tls: true

    templates:
    - name: 'pagerduty.default.client_url'
      template: |
        {{ if .CommonAnnotations.runbook_url -}}
          {{- .CommonAnnotations.runbook_url -}}
        {{- else -}}
          {{- .ExternalURL -}}
        {{- end }}