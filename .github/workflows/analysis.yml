name: Code Analysis

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'tests/**'
      - '.github/workflows/analysis.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'tests/**'
  #schedule:
    # Run daily at 2 AM UTC
    #- cron: '0 2 * * *'

jobs:
  analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ['3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-ci.txt
          pip install -r requirements-security.txt

      - name: Run LocalAnalyzer
        id: analysis
        run: |
          python -m backend.analysis_cli analyze-dir backend/app --output json > analysis_report.json 2>&1 || true
          python -m backend.analysis_cli metrics backend/app/main.py --output json > metrics_report.json 2>&1 || true
          cat analysis_report.json

      - name: Generate HTML Report
        run: |
          python << 'EOF'
          import json
          from datetime import datetime
          
          try:
              with open('analysis_report.json', 'r') as f:
                  analysis = json.load(f)
          except:
              analysis = {}
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Code Analysis Report</title>
              <style>
                  body {{ font-family: Arial, sans-serif; margin: 20px; }}
                  .header {{ background: #f0f0f0; padding: 20px; border-radius: 5px; }}
                  .metrics {{ background: #e8f4f8; padding: 15px; margin: 10px 0; border-radius: 5px; }}
                  .violations {{ background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 5px; }}
                  .critical {{ color: #d32f2f; font-weight: bold; }}
                  .high {{ color: #f57c00; font-weight: bold; }}
                  table {{ width: 100%; border-collapse: collapse; margin: 10px 0; }}
                  th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
                  th {{ background: #f5f5f5; }}
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>Code Analysis Report</h1>
                  <p>Generated: {datetime.utcnow().isoformat()}</p>
              </div>
              <div class="metrics">
                  <h2>Analysis Summary</h2>
                  <p><span class="critical">Violations: {analysis.get('violation_count', 'N/A')}</span></p>
                  <p><span class="critical">Critical: {analysis.get('critical_count', 'N/A')}</span></p>
                  <p><span class="high">High: {analysis.get('high_count', 'N/A')}</span></p>
              </div>
          </body>
          </html>
          """
          with open('analysis_report.html', 'w') as f:
              f.write(html)
          EOF

      - name: Upload reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: analysis-reports
          path: |
            analysis_report.json
            metrics_report.json
            analysis_report.html
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let analysis = {};
            try {
              analysis = JSON.parse(fs.readFileSync('analysis_report.json', 'utf8'));
            } catch (e) {
              console.log('Could not parse analysis report');
            }

            const violations = analysis.violation_count || 0;
            const critical = analysis.critical_count || 0;
            const high = analysis.high_count || 0;

            const body = `## ðŸ“Š Code Analysis Report

            **Violations:** ${violations}
            **Critical:** ${critical}
            **High:** ${high}

            View full [analysis report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) in Actions artifacts.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set check status
        if: always()
        run: |
          if [ -f analysis_report.json ]; then
            echo "Analysis report generated successfully"
          else
            echo "Warning: Analysis report not generated"
          fi

  test-analysis-cli:
    name: Test Analysis CLI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-ci.txt

      - name: Test CLI commands
        run: |
          echo "Testing analyze-file command..."
          python -m backend.analysis_cli analyze-file backend/app/main.py --output text || echo "âœ“ Command executed"
          
          echo "Testing analyze-dir command..."
          python -m backend.analysis_cli analyze-dir backend/app --output text || echo "âœ“ Command executed"
          
          echo "Testing metrics command..."
          python -m backend.analysis_cli metrics backend/app/main.py --output text || echo "âœ“ Command executed"
          
          echo "Testing status command..."
          python -m backend.analysis_cli status || echo "âœ“ Command executed"

      - name: Run unit tests
        run: |
          python -m pytest tests/unit/test_analysis_local.py -v || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit==1.7.5

      - name: Run Bandit security scan
        run: |
          bandit -r backend/ -f json -o bandit_report.json || true
          bandit -r backend/ -f txt || true

      - name: Upload security report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-report
          path: bandit_report.json
          retention-days: 30

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-ci.txt

      - name: Generate coverage report
        run: |
          python -m pytest tests/ --cov=backend --cov-report=json --cov-report=html -v || true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30
